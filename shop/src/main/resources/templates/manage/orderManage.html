<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>FastShop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/css/icons.min.css" rel="stylesheet" type="text/css"/>
    <link href="/css/theme.min.css" rel="stylesheet" type="text/css"/>

    <link href="/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/select2/select2.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/switchery/switchery.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/bootstrap-colorpicker/bootstrap-colorpicker.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css"/>


</head>

<body>

<!-- Begin page -->
<div id="layout-wrapper">
    <div class="header-border"></div>


    <!-- ========== Left Sidebar Start ========== -->
    <div th:include="manage/menus"></div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-flex align-items-center justify-content-between">
                            <h4 class="mb-0 font-size-18">订单管理</h4>

                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">

                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <input type="text" class="form-control date" id="datepicker"
                                       onchange="dateChange()"
                                       th:value="${date}"
                                       data-toggle="daterangepicker" data-single-date-picker="true"
                                       style="width: 200px">
                                <form action="orderSearch" method="get">
                                    <input type="text" style="width: 30%" class="form-control" placeholder="人名、手机号，回车模糊搜索" name="search"/>
                                </form>
                                <div class="mt-3">
                                    <div class="custom-control custom-checkbox custom-control-inline"
                                         th:each="state:${statusMap}">
                                        <input type="checkbox"
                                               class="custom-control-input"
                                               name="statusCheckBox"
                                               onchange="statusCheckBoxChange()"
                                               th:value="${state.value.name()}"
                                               th:checked="${currentStatus.contains(state.value.name())}"
                                               th:id="${'stateId_'+state.key}">
                                        <label class="custom-control-label" th:for="${'stateId_'+state.key}"
                                               th:text="${state.value.name}">Check this custom checkbox</label>
                                    </div>
                                </div>
                                <div style="height: 15px"></div>
                                <table id="datatable-buttons" class="table table-striped dt-responsive nowrap">
                                    <thead>
                                    <tr>
                                        <th>订单类型</th>
                                        <th>商品预览</th>
                                        <th>商品总数</th>
                                        <th>商品总价</th>
                                        <th>买家</th>
                                        <th>下单时间</th>
                                        <th>拼团状态</th>
                                        <th>订单状态</th>
                                        <th>配送员</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>


                                    <tbody>
                                    <tr th:each="order:${orders}">
                                        <td>
                                            <span class="badge badge-info badge-pill"
                                                  th:if="${order.value.get(0).ptOrder == null || order.value.get(0).ptOrder == false}">普通</span>
                                            <span class="badge badge-secondary badge-pill"
                                                  th:if="${order.value.get(0).ptOrder != null && order.value.get(0).ptOrder == true}"
                                                  th:text="${order.value.get(0).product.ptSize+'人团'}">3人团</span>
                                        </td>

                                        <td>
                                            <a th:each="it,stat:${order.value}"
                                               th:if="${stat.index < 3}"
                                               th:href="${'http://127.0.0.1:8080/manage/editGoods?id='+it.productId}"
                                               target="_blank"><img
                                                    data-toggle="tooltip"
                                                    data-placement="top" title=""
                                                    th:data-original-title="${it.product.title}"
                                                    style="width: 50px;height: 50px" th:src="${it.product.imgUrl}"/>
                                            </a>
                                        </td>
                                        <td>
                                            <span th:text="${order.value.size()}">2</span>
                                        </td>

                                        <td>
                                            <span th:text="${#numbers.formatDecimal(totalPrices[order.key]/100.0,1,2)}">2</span>
                                        </td>

                                        <td>
                                            <img style="width: 50px;height: 50px"
                                                 data-toggle="tooltip"
                                                 data-placement="top" title=""
                                                 th:data-original-title="${order.value.get(0).buyerName}"
                                                 th:src="${order.value.get(0).buyerAvatar}"/></td>
                                        <td th:text="${order.value.get(0).createdTime}">System Architect</td>

                                        <td th:if="${order.value.get(0).ptOrder != null && order.value.get(0).ptOrder}"
                                            th:text="${order.value.get(0).tuanStatus.desc}">System Architect
                                        </td>
                                        <td th:if="${order.value.get(0).ptOrder == null || order.value.get(0).ptOrder == false}">-</td>

                                        <td th:text="${statusMap[order.value.get(0).status].getName()}">System Architect</td>
                                        <td th:text="${order.value.get(0).bindRider != null?order.value.get(0).rider.userName:'-'}">System Architect</td>
                                        <td>
                                            <div class="btn-group" role="group" th:if="${order.value.get(0).ptOrder == false && order.value.get(0).status == 2}">
                                                <button type="button"
                                                        th:onclick="${'markProcessing('+order.key+')'}"
                                                        class="btn btn-success">
                                                    发货
                                                </button>
                                            </div>
                                            <div class="btn-group" role="group" th:if="${order.value.get(0).ptOrder == true && order.value.get(0).status == 2 && order.value.get(0).tuanStatus.name() == 'FULL'}">
                                                <button type="button"
                                                        th:onclick="${'markProcessing('+order.key+')'}"
                                                        class="btn btn-success">
                                                    发货
                                                </button>
                                            </div>
                                            <button type="button" th:onclick="${'print('+order.key+')'}" class="btn btn-info waves-effect waves-light">打印</button>
                                            <div class="btn-group" role="group">
                                                <button type="button"
                                                        th:onclick="${'orderDetail('+order.key+')'}"
                                                        class="btn btn-secondary">
                                                    详情
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>

                            </div> <!-- end card body-->
                        </div> <!-- end card -->
                    </div><!-- end col-->
                </div>
                <!-- end row-->


            </div> <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
    </div>
    <!-- end main content-->

</div>
<!-- END layout-wrapper -->

<!-- Overlay-->
<div class="menu-overlay"></div>

<script>
    function orderDetail(batchId) {
        Swal.fire({
            type: 'info',
            animation:false,
            width: 1100,
            padding: 1,
            html: '<iframe style="width: 100%;height: 500px"  src="/manage/orderDetail?batchId='+batchId+'"></iframe>',
            showConfirmButton: false
        });
    }

    function markProcessing(batchId) {
        markOrder2Status(batchId, 3);
    }

    function markComplete(batchId) {
        markOrder2Status(batchId, 4);
    }

    function markOrder2Status(batchId, status) {
        $.getJSON('markOrder?batchId=' + batchId + '&status=' + status, function (resp) {
            window.location.reload();
        })
    }

    function print(batchId) {
        $.getJSON('printOrder?batchId=' + batchId, function (resp) {
            if(resp.status != 'SUCCESS'){
                Swal.fire({
                    icon: 'error',
                    title: '发生错误',
                    text: resp.msg
                })
            }else{
                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: '已发送打印任务',
                    showConfirmButton: false,
                    timer: 1500
                })
            }
        })
    }

    function dateChange() {
        if (window.location.href.indexOf($("#datepicker").val()) == -1) {
            statusCheckBoxChange();
        }
    }

    function statusCheckBoxChange() {
        var ss = '';
        $("[name='statusCheckBox']").each(function () {
            if ($(this).is(':checked')) {
                ss += ',' + $(this).val();
            }
        })
        if (ss != '') {
            ss = ss.substr(1);
        }
        window.location.href = "orderManage?status=" + ss + "&date=" + $("#datepicker").val();
    }
</script>
<!-- jQuery  -->
<script src="/js/jquery-1.8.1.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/metismenu.min.js"></script>
<script src="/js/waves.js"></script>
<script src="/js/simplebar.min.js"></script>


<!-- Sweet Alerts Js-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<!-- Plugins js -->
<script src="/plugins/autonumeric/autoNumeric-min.js"></script>
<script src="/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
<script src="/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
<script src="/plugins/moment/moment.js"></script>
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/select2/select2.min.js"></script>
<script src="/plugins/switchery/switchery.min.js"></script>
<script src="/plugins/bootstrap-colorpicker/bootstrap-colorpicker.min.js"></script>
<script src="/plugins/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js"></script>
<!-- third party js ends -->

<!-- Sparkline Js-->
<script src="/plugins/jquery-sparkline/jquery.sparkline.min.js"></script>
<!-- Chart Js-->
<script src="/plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- Chart Custom Js-->
<!--<script src="assets/pages/knob-chart-demo.js"></script>-->
<!-- Morris Js-->
<script src="/plugins/morris-js/morris.min.js"></script>
<!-- Raphael Js-->
<script src="/plugins/raphael/raphael.min.js"></script>
<!-- Custom Js -->
<!--<script src="assets/pages/dashboard-demo.js"></script>-->
<!-- App js -->
<script src="/js/theme.js"></script>
<!--<script src="/js/table-init.js"></script>-->
<script src="/js/date-picker-init.js"></script>
</body>

</html>