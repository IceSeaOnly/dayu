<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>FastShop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/css/icons.min.css" rel="stylesheet" type="text/css"/>
    <link href="/css/theme.min.css" rel="stylesheet" type="text/css"/>

    <link href="/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/select2/select2.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/switchery/switchery.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/bootstrap-colorpicker/bootstrap-colorpicker.min.css" rel="stylesheet" type="text/css"/>
    <link href="/plugins/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css"/>


</head>

<body>

<!-- Begin page -->
<div id="layout-wrapper">
    <div class="header-border"></div>


    <!-- ========== Left Sidebar Start ========== -->
    <div th:include="manage/menus"></div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-flex align-items-center justify-content-between">
                            <h4 class="mb-0 font-size-18">工资管理</h4>

                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">

                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="width: 100%">
                                    开始时间：<input type="text" id="datepicker"
                                                th:value="${start}"
                                                data-toggle="daterangepicker" data-single-date-picker="true"
                                                style="width: 200px">
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    结束时间：<input type="text" id="datepicker2"
                                                th:value="${end}"
                                                data-toggle="daterangepicker" data-single-date-picker="true"
                                                style="width: 200px">
                                    <button class="btn btn-sm btn-info" onclick="statusCheckBoxChange()">查询</button>
                                </div>


                                <div class="mt-3">
                                    <div class="custom-control custom-checkbox custom-control-inline"
                                         th:each="rider:${riders}">
                                        <input type="checkbox"
                                               class="custom-control-input"
                                               name="statusCheckBox"
                                               onchange="statusCheckBoxChange()"
                                               th:value="${rider.id}"
                                               th:checked="${currentSelected != null && currentSelected.contains(''+rider.id)}"
                                               th:id="${'rider_'+rider.id}">
                                        <label class="custom-control-label" th:for="${'rider_'+rider.id}"
                                               th:text="${rider.remark+'('+rider.userName+')'}">Check this custom
                                            checkbox</label>
                                    </div>
                                </div>
                                <div style="height: 15px"></div>
                                <table id="datatable-buttons" class="table table-striped dt-responsive nowrap">
                                    <thead>
                                    <tr>
                                        <th>骑手名称</th>
                                        <th>骑手备注</th>
                                        <th th:each="state:${salaryStates}" th:text="${state.value}">
                                            商品总数
                                        </th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>


                                    <tbody>
                                    <tr th:each="rider:${selectedRiders}">
                                        <td th:text="${rider.userName}">user name</td>
                                        <td th:text="${rider.remark}">user remark</td>
                                        <td th:each="state:${salaryStates}"
                                            th:text="${logs.get(rider.id).get(state.key)/100.0}">
                                            商品总数
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info"
                                                    th:onclick="${'salaryDetail('+rider.id+')'}">明细
                                            </button>
                                            <button class="btn btn-sm btn-success"
                                                    th:onclick="${'settle('+rider.id+')'}">结算
                                            </button>
                                            <button class="btn btn-sm btn-warning"
                                                    th:onclick="${'ajaxBook('+rider.id+')'}">调账
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>

                            </div> <!-- end card body-->
                        </div> <!-- end card -->
                    </div><!-- end col-->
                </div>
                <!-- end row-->


            </div> <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
    </div>
    <!-- end main content-->

</div>
<!-- END layout-wrapper -->

<!-- Overlay-->
<div class="menu-overlay"></div>

<script th:inline="javascript">

    var salaryScenes = [[${salaryScenes}]];
    var salaryStates = [[${salaryStates}]];

    function ajaxBook(rider) {
        Swal.mixin({
            input: 'text',
            confirmButtonText: '下一步',
            cancelButtonText: '取消',
            showCancelButton: true,
            animation: false,
            progressSteps: ['1', '2', '3', '4']
        }).queue([
            {
                title: '金额',
                text: '单位分，正负皆可'
            },
            {
                title: '类型',
                input: 'select',
                inputOptions: salaryScenes
            },
            {
                title: '状态',
                input: 'select',
                inputOptions: salaryStates
            },
            {
                title: '备注',
                text: '简要描述'
            }
        ]).then((result) => {
            var salary = result.value[0];
            var scene = result.value[1];
            var state = result.value[2];
            var remark = result.value[3];

            $.getJSON('ajaxBook?rider=' + rider + '&status=' + state + '&scene=' + scene + '&remark=' + remark + '&salary=' + salary, function (resp) {
                Swal.fire(
                    '添加完成',
                    '',
                    'success'
                ).then(function (t) {
                    window.location.reload();
                })
            })
        })
    }

    function salaryDetail(riderId) {
        var param = 'rider=' + riderId + "&start=" + $("#datepicker").val() + "&end=" + $("#datepicker2").val();
        Swal.fire({
            type: 'info',
            animation: false,
            width: 1100,
            padding: 1,
            html: '<iframe style="width: 100%;height: 500px"  src="/manage/salaryDetail?' + param + '"></iframe>',
            showConfirmButton: false
        });
    }

    function settle(riderId) {
        var dateRange = $("#datepicker").val() + "-" + $("#datepicker2").val();
        Swal.fire({
            title: '确定结算该骑手' + dateRange + '未结算的工资吗?',
            text: "点击确认后计算出最终应结工资!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '结算',
            cancelButtonText: '下次再说',
        }).then((result) => {
            if (result.value) {
                $.getJSON('settle?rider=' + riderId + "&start=" + $("#datepicker").val() + "&end=" + $("#datepicker2").val(), function (resp) {
                    Swal.fire(
                        '结算完成!',
                        '总共应结算￥' + resp.data / 100.0 + '，请线下自行转账',
                        'success'
                    ).then(function (t) {
                        window.location.reload();
                    })
                })
            }
        })
    }


    function statusCheckBoxChange() {
        var ss = '';
        $("[name='statusCheckBox']").each(function () {
            if ($(this).is(':checked')) {
                ss += ',' + $(this).val();
            }
        })
        if (ss != '') {
            ss = ss.substr(1);
        }
        window.location.href = "salaryManage?selected=" + ss + "&start=" + $("#datepicker").val() + "&end=" + $("#datepicker2").val();
    }
</script>
<!-- jQuery  -->
<script src="/js/jquery-1.8.1.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/metismenu.min.js"></script>
<script src="/js/waves.js"></script>
<script src="/js/simplebar.min.js"></script>


<!-- Sweet Alerts Js-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<!-- Plugins js -->
<script src="/plugins/autonumeric/autoNumeric-min.js"></script>
<script src="/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
<script src="/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
<script src="/plugins/moment/moment.js"></script>
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/select2/select2.min.js"></script>
<script src="/plugins/switchery/switchery.min.js"></script>
<script src="/plugins/bootstrap-colorpicker/bootstrap-colorpicker.min.js"></script>
<script src="/plugins/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js"></script>
<!-- third party js ends -->

<!-- Sparkline Js-->
<script src="/plugins/jquery-sparkline/jquery.sparkline.min.js"></script>
<!-- Chart Js-->
<script src="/plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- Chart Custom Js-->
<!--<script src="assets/pages/knob-chart-demo.js"></script>-->
<!-- Morris Js-->
<script src="/plugins/morris-js/morris.min.js"></script>
<!-- Raphael Js-->
<script src="/plugins/raphael/raphael.min.js"></script>
<!-- Custom Js -->
<!--<script src="assets/pages/dashboard-demo.js"></script>-->
<!-- App js -->
<script src="/js/theme.js"></script>
<!--<script src="/js/table-init.js"></script>-->
<script src="/js/date-picker-init.js"></script>
</body>

</html>